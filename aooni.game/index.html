<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>„Çä„Åè„Åè„Çì„Å®„Éù„Ç≥„Éù„Ç≥ÈùíÈ¨º</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: 'Arial', sans-serif;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* UI„É¨„Ç§„É§„Éº */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* „Çπ„Ç≥„Ç¢„Éª„É°„ÉÉ„Çª„Éº„Ç∏ */
        #message-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            border: 3px solid #FF9800;
            text-align: center;
            pointer-events: auto;
        }

        /* „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´ */
        #debug-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            min-width: 250px;
            display: none;
            pointer-events: auto;
        }

        #debug-panel h3 {
            margin: 0 0 10px 0;
            color: #FF9800;
        }

        .debug-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .debug-section:last-child {
            border-bottom: none;
        }

        .debug-label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }

        .debug-slider {
            width: 100%;
            margin-bottom: 5px;
        }

        .debug-btn {
            padding: 8px 12px;
            margin: 5px 5px 5px 0;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .debug-btn:hover {
            background: #45a049;
        }

        .debug-toggle {
            background: #2196F3;
        }

        .debug-toggle.active {
            background: #FF9800;
        }

        #debug-state-text {
            color: #FFD700;
            font-weight: bold;
        }

        /* „Éà„Ç∞„É´„Éú„Çø„É≥ */
        #debug-toggle-btn {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            pointer-events: auto;
            font-size: 12px;
        }

        /* Êìç‰Ωú„Éë„Éç„É´ÔºàiPadÁî®Ôºâ */
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 150px;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* „Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅØÂãïÁöÑÁîüÊàê„Åô„Çã„Åü„ÇÅÂàùÊúüÈùûË°®Á§∫ */
        .joystick-wrapper {
            position: absolute;
            width: 150px;
            height: 150px;
            pointer-events: auto;
            display: none;
        }

        .joystick-base {
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
        }

        .joystick-knob {
            width: 60px;
            height: 60px;
            background: #FF9800;
            border-radius: 50%;
            position: absolute;
            top: 45px;
            left: 45px;
            box-shadow: 0 4px 0 #E65100;
        }

        /* „Éú„Çø„É≥„Ç®„É™„Ç¢ */
        #buttons-zone {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            pointer-events: auto;
        }

        .game-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .game-btn:active {
            transform: translateY(4px);
        }

        #btn-action {
            background: #4CAF50;
        }

        #btn-camera {
            background: #2196F3;
            font-size: 14px;
        }

        /* „ÇØ„Ç§„Ç∫„Éª„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: auto;
            display: none;
        }

        #overlay-text {
            color: white;
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
        }

        .quiz-btn {
            padding: 15px 30px;
            margin: 10px;
            font-size: 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        #start-btn {
            padding: 20px 40px;
            font-size: 30px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 15px;
            border-bottom: 5px solid #E65100;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>

    <div id="game-container">
        <div id="ui-layer">
            <div id="message-box">„Éü„ÉÉ„Ç∑„Éß„É≥Ôºö<br>„Åä„ÇÇ„Å°„ÇÉ „Çí „Åã„Åü„Å•„Åë„Å¶ÔºÅ</div>
            
            <!-- „Éá„Éê„ÉÉ„Ç∞„Éà„Ç∞„É´„Éú„Çø„É≥ -->
            <button id="debug-toggle-btn">üêõ „Éá„Éê„ÉÉ„Ç∞</button>
            
            <!-- „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´ -->
            <div id="debug-panel">
                <h3>üéÆ „Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´</h3>
                
                <div class="debug-section">
                    <button id="god-mode-btn" class="debug-btn debug-toggle">God Mode: OFF</button>
                    <button id="skip-mission-btn" class="debug-btn">„Éü„ÉÉ„Ç∑„Éß„É≥„Çπ„Ç≠„ÉÉ„Éó</button>
                </div>
                
                <div class="debug-section">
                    <label class="debug-label">„Éó„É¨„Ç§„É§„ÉºÈÄüÂ∫¶: <span id="player-speed-val">0.15</span></label>
                    <input type="range" class="debug-slider" id="player-speed" min="0.05" max="0.5" step="0.01" value="0.15">
                    
                    <label class="debug-label">ÊïµÈÄüÂ∫¶: <span id="enemy-speed-val">0.06</span></label>
                    <input type="range" class="debug-slider" id="enemy-speed" min="0.01" max="0.3" step="0.01" value="0.06">
                </div>
                
                <div class="debug-section">
                    <button id="visual-debug-btn" class="debug-btn debug-toggle">Ë¶ñË¶ö„Éá„Éê„ÉÉ„Ç∞: OFF</button>
                    <div id="debug-state-text">Áä∂ÊÖã: ÂæÖÊ©ü‰∏≠</div>
                </div>
            </div>

            <div id="controls">
                <!-- „Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅØÂãïÁöÑÁîüÊàê -->
            </div>

            <div id="buttons-zone">
                <button id="btn-camera" class="game-btn">„Ç´„É°„É©<br>„Åç„Çä„Åã„Åà</button>
                <button id="btn-action" class="game-btn">‚úã</button>
            </div>
        </div>

        <div id="overlay">
            <div id="overlay-text">„Çä„Åè„Åè„Çì„Å®<br>„Éù„Ç≥„Éù„Ç≥ÈùíÈ¨º</div>
            <button id="start-btn">„ÅÇ„Åù„Å∂ÔºÅ</button>
            <div id="quiz-options" style="display:none;"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG: ÂÖ®„Å¶„ÅÆÂÆöÊï∞„Çí„Åì„Åì„Å´ÈõÜÁ¥Ñ
        // ==========================================
        const CONFIG = {
            player: {
                speed: 0.15,
                radius: 0.4,
                height: 0.8,
                color: 0xFF9800
            },
            enemy: {
                speed: 0.06,
                chaseDistance: 15,
                handiCapDistance: 3.0,
                handiCapMultiplier: 0.5,
                catchDistance: 1.0,
                color: 0x6A5ACD
            },
            world: {
                mapSize: 10,
                wallHeight: 3,
                wallSize: 2,
                floorColor: 0x8BC34A,
                wallColor: 0xFFE0B2,
                skyColor: 0xCDF0FF
            },
            camera: {
                fov: 60,
                near: 0.1,
                far: 100,
                thirdPersonOffset: { x: 0, y: 5, z: 6 },
                firstPersonOffset: { y: 0.5 }
            },
            shadows: {
                resolution: 2048,
                bias: -0.001
            },
            joystick: {
                baseSize: 150,
                knobSize: 60,
                maxDistance: 45
            }
        };

        // ==========================================
        // „ÉÜ„ÇØ„Çπ„ÉÅ„É£„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº
        // ==========================================
        class TextureGenerator {
            // Êú®ÁõÆ„ÉÜ„ÇØ„Çπ„ÉÅ„É£
            static createWoodTexture(width = 256, height = 256) {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // „Éô„Éº„ÇπËâ≤
                ctx.fillStyle = '#D2691E';
                ctx.fillRect(0, 0, width, height);

                // Êú®ÁõÆ„Éë„Çø„Éº„É≥
                for (let i = 0; i < 20; i++) {
                    ctx.strokeStyle = `rgba(101, 67, 33, ${0.1 + Math.random() * 0.3})`;
                    ctx.lineWidth = 1 + Math.random() * 3;
                    ctx.beginPath();
                    ctx.moveTo(0, Math.random() * height);
                    for (let x = 0; x < width; x += 10) {
                        ctx.lineTo(x, Math.random() * height);
                    }
                    ctx.stroke();
                }

                const texture = new THREE.CanvasTexture(canvas);
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                return texture;
            }

            // Â∏ÉÂú∞„ÉÜ„ÇØ„Çπ„ÉÅ„É£
            static createFabricTexture(baseColor, width = 256, height = 256) {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = baseColor;
                ctx.fillRect(0, 0, width, height);

                // Áπî„ÇäÁõÆ„Éë„Çø„Éº„É≥
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.lineWidth = 1;
                for (let i = 0; i < width; i += 4) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, height);
                    ctx.stroke();
                }
                for (let i = 0; i < height; i += 4) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(width, i);
                    ctx.stroke();
                }

                return new THREE.CanvasTexture(canvas);
            }

            // È°î„ÉÜ„ÇØ„Çπ„ÉÅ„É£ÔºàÈùíÈ¨ºÁî®Ôºâ
            static createFaceTexture(width = 256, height = 256) {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // ËÉåÊôØÔºàËÇåËâ≤Ôºâ
                ctx.fillStyle = '#9370DB';
                ctx.fillRect(0, 0, width, height);

                // ÁõÆÔºàÁôΩÔºâ
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(width * 0.35, height * 0.4, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(width * 0.65, height * 0.4, 30, 0, Math.PI * 2);
                ctx.fill();

                // Áû≥
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(width * 0.35, height * 0.4, 12, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(width * 0.65, height * 0.4, 12, 0, Math.PI * 2);
                ctx.fill();

                // Âè£ÔºàÁ¨ëÈ°îÔºâ
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(width * 0.5, height * 0.55, 40, 0, Math.PI);
                ctx.stroke();

                return new THREE.CanvasTexture(canvas);
            }

            // ËçâÂú∞„ÉÜ„ÇØ„Çπ„ÉÅ„É£
            static createGrassTexture(width = 512, height = 512) {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // „Éô„Éº„Çπ
                ctx.fillStyle = '#8BC34A';
                ctx.fillRect(0, 0, width, height);

                // „É©„É≥„ÉÄ„É†„Å™Ëçâ„ÅÆÁÇπ
                for (let i = 0; i < 1000; i++) {
                    const x = Math.random() * width;
                    const y = Math.random() * height;
                    const shade = Math.random();
                    ctx.fillStyle = shade > 0.5 ? '#7CB342' : '#9CCC65';
                    ctx.fillRect(x, y, 2, 2);
                }

                const texture = new THREE.CanvasTexture(canvas);
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(10, 10);
                return texture;
            }
        }

        // ==========================================
        // InputManager: „Çø„ÉÉ„ÉÅÂÖ•ÂäõÁÆ°ÁêÜ
        // ==========================================
        class InputManager {
            constructor() {
                this.joysticks = []; // Ë§áÊï∞„ÅÆ„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÇíÁÆ°ÁêÜ
                this.activeTouches = new Map(); // touchId -> joystick mapping
            }

            // „ÉÄ„Ç§„Éä„Éü„ÉÉ„ÇØ„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅÆ‰ΩúÊàê
            createDynamicJoystick(x, y) {
                const wrapper = document.createElement('div');
                wrapper.className = 'joystick-wrapper';
                wrapper.style.left = `${x - CONFIG.joystick.baseSize / 2}px`;
                wrapper.style.top = `${y - CONFIG.joystick.baseSize / 2}px`;
                wrapper.style.display = 'block';

                const base = document.createElement('div');
                base.className = 'joystick-base';

                const knob = document.createElement('div');
                knob.className = 'joystick-knob';

                base.appendChild(knob);
                wrapper.appendChild(base);
                document.getElementById('ui-layer').appendChild(wrapper);

                return {
                    wrapper,
                    knob,
                    baseX: x,
                    baseY: y,
                    x: 0,
                    y: 0,
                    active: true
                };
            }

            setupTouchControls() {
                // ÁîªÈù¢Â∑¶ÂçäÂàÜ„Åß„ÅÆ„Çø„ÉÉ„ÉÅ„Çí„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„Å®„Åó„Å¶Âá¶ÁêÜ
                document.addEventListener('touchstart', (e) => {
                    for (let touch of e.touches) {
                        // Â∑¶ÂçäÂàÜ„ÅÆ„Åø„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ
                        if (touch.clientX < window.innerWidth / 2) {
                            if (!this.activeTouches.has(touch.identifier)) {
                                const joystick = this.createDynamicJoystick(touch.clientX, touch.clientY);
                                this.activeTouches.set(touch.identifier, joystick);
                                this.joysticks.push(joystick);
                            }
                        }
                    }
                }, { passive: true });

                document.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    for (let touch of e.touches) {
                        const joystick = this.activeTouches.get(touch.identifier);
                        if (joystick) {
                            const dx = touch.clientX - joystick.baseX;
                            const dy = touch.clientY - joystick.baseY;

                            const distance = Math.min(CONFIG.joystick.maxDistance, Math.sqrt(dx * dx + dy * dy));
                            const angle = Math.atan2(dy, dx);

                            joystick.x = (Math.cos(angle) * distance) / CONFIG.joystick.maxDistance;
                            joystick.y = (Math.sin(angle) * distance) / CONFIG.joystick.maxDistance;

                            joystick.knob.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
                        }
                    }
                }, { passive: false });

                const endTouch = (e) => {
                    for (let touch of e.changedTouches) {
                        const joystick = this.activeTouches.get(touch.identifier);
                        if (joystick) {
                            joystick.wrapper.remove();
                            this.joysticks = this.joysticks.filter(j => j !== joystick);
                            this.activeTouches.delete(touch.identifier);
                        }
                    }
                };

                document.addEventListener('touchend', endTouch);
                document.addEventListener('touchcancel', endTouch);
            }

            getMovementInput() {
                // ÊúÄÂàù„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅÆÂÄ§„ÇíËøî„Åô
                if (this.joysticks.length > 0) {
                    return {
                        x: this.joysticks[0].x,
                        y: this.joysticks[0].y,
                        active: true
                    };
                }
                return { x: 0, y: 0, active: false };
            }
        }

        // ==========================================
        // Player: „Éó„É¨„Ç§„É§„ÉºÁÆ°ÁêÜ
        // ==========================================
        class Player {
            constructor(scene) {
                // CapsuleGeometry„ÅØr128„Åß„ÅØ‰Ωø„Åà„Å™„ÅÑ„Åü„ÇÅ„ÄÅCylinderGeometry„Çí‰ΩøÁî®
                const geo = new THREE.CylinderGeometry(CONFIG.player.radius, CONFIG.player.radius, CONFIG.player.height, 16);
                const fabricTex = TextureGenerator.createFabricTexture('#FF9800');
                const mat = new THREE.MeshStandardMaterial({ map: fabricTex });
                
                this.mesh = new THREE.Mesh(geo, mat);
                this.mesh.position.set(0, 0.9, 0);
                this.mesh.castShadow = true;
                scene.add(this.mesh);

                this.speed = CONFIG.player.speed;
            }

            update(input, walls) {
                if (input.active) {
                    const moveX = input.x * this.speed;
                    const moveZ = input.y * this.speed;

                    this.mesh.position.x += moveX;
                    this.mesh.position.z += moveZ;

                    // Á∞°ÊòìÂ£ÅÂà§ÂÆöÔºà„Éû„ÉÉ„ÉóÂ¢ÉÁïåÔºâ
                    const limit = (CONFIG.world.mapSize - 1) * CONFIG.world.wallSize / 2;
                    if (Math.abs(this.mesh.position.x) > limit) {
                        this.mesh.position.x = Math.sign(this.mesh.position.x) * limit;
                    }
                    if (Math.abs(this.mesh.position.z) > limit) {
                        this.mesh.position.z = Math.sign(this.mesh.position.z) * limit;
                    }

                    this.mesh.lookAt(
                        this.mesh.position.x + moveX,
                        this.mesh.position.y,
                        this.mesh.position.z + moveZ
                    );
                }
            }

            getPosition() {
                return this.mesh.position;
            }

            reset() {
                this.mesh.position.set(0, 0.9, 0);
            }
        }

        // ==========================================
        // Enemy: ÊïµAIÔºàÈùíÈ¨ºÔºâ
        // ==========================================
        class Enemy {
            constructor(scene) {
                this.group = new THREE.Group();

                // ‰ΩìÔºà„ÉÜ„ÇØ„Çπ„ÉÅ„É£ÈÅ©Áî®Ôºâ
                const bodyGeo = new THREE.SphereGeometry(0.8, 32, 32);
                const faceTex = TextureGenerator.createFaceTexture();
                const bodyMat = new THREE.MeshStandardMaterial({ 
                    color: CONFIG.enemy.color,
                    map: faceTex
                });
                const body = new THREE.Mesh(bodyGeo, bodyMat);
                body.position.y = 1.0;
                body.scale.set(1, 1.3, 1);
                body.castShadow = true;
                this.group.add(body);

                // ÁõÆ
                const eyeGeo = new THREE.SphereGeometry(0.2, 16, 16);
                const eyeMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
                eyeL.position.set(-0.3, 1.2, 0.6);
                const eyeR = new THREE.Mesh(eyeGeo, eyeMat);
                eyeR.position.set(0.3, 1.2, 0.6);
                this.group.add(eyeL, eyeR);

                // Áû≥
                const pupilGeo = new THREE.SphereGeometry(0.08, 8, 8);
                const pupilMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                const pupilL = new THREE.Mesh(pupilGeo, pupilMat);
                pupilL.position.set(-0.3, 1.2, 0.75);
                const pupilR = new THREE.Mesh(pupilGeo, pupilMat);
                pupilR.position.set(0.3, 1.2, 0.75);
                this.group.add(pupilL, pupilR);

                this.group.position.set(6, 0, 6);
                scene.add(this.group);

                this.speed = CONFIG.enemy.speed;
                this.state = 'ÂæÖÊ©ü‰∏≠';
                this.debugLines = [];
            }

            update(playerPos, currentMissionPos, walls, scene) {
                const distToPlayer = this.group.position.distanceTo(playerPos);

                if (distToPlayer < CONFIG.enemy.chaseDistance) {
                    this.state = 'ËøΩË∑°‰∏≠';

                    // „Éó„É¨„Ç§„É§„Éº„Å∏„ÅÆÊñπÂêë„Éô„ÇØ„Éà„É´
                    const dir = new THREE.Vector3().subVectors(playerPos, this.group.position).normalize();

                    // Â£ÅÂõûÈÅø„É≠„Ç∏„ÉÉ„ÇØÔºàÁ∞°Êòì„É¨„Ç§„Ç≠„É£„Çπ„ÉàÔºâ
                    const raycaster = new THREE.Raycaster(this.group.position, dir, 0, 2);
                    const intersects = raycaster.intersectObjects(walls);

                    if (intersects.length > 0) {
                        // Â£Å„Å´„Å∂„Å§„Åã„Çä„Åù„ÅÜ„Å™„ÇâÊ®™„Å´„Çπ„É©„Ç§„Éâ
                        const normal = intersects[0].face.normal;
                        const slideDir = dir.clone().sub(normal.clone().multiplyScalar(dir.dot(normal))).normalize();
                        dir.copy(slideDir);
                    }

                    // ÊâãÂä†Ê∏õ„É≠„Ç∏„ÉÉ„ÇØ
                    let currentSpeed = this.speed;
                    if (currentMissionPos) {
                        const distToMission = playerPos.distanceTo(currentMissionPos);
                        if (distToMission < CONFIG.enemy.handiCapDistance) {
                            currentSpeed *= CONFIG.enemy.handiCapMultiplier;
                            this.state = 'ÊâãÂä†Ê∏õ„É¢„Éº„Éâ';
                        }
                    }

                    this.group.position.add(dir.multiplyScalar(currentSpeed));
                    this.group.lookAt(playerPos);

                    // „Éî„Éß„É≥„Éî„Éß„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    this.group.position.y = Math.abs(Math.sin(Date.now() * 0.005)) * 0.5;
                } else {
                    this.state = 'ÂæÖÊ©ü‰∏≠';
                }
            }

            getPosition() {
                return this.group.position;
            }

            getState() {
                return this.state;
            }

            reset() {
                this.group.position.set(6, 0, 6);
            }
        }

        // ==========================================
        // DebugPanel: „Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´
        // ==========================================
        class DebugPanel {
            constructor(game) {
                this.game = game;
                this.godMode = false;
                this.visualDebug = false;
                this.debugLines = [];

                this.setupUI();
            }

            setupUI() {
                // „Éà„Ç∞„É´„Éú„Çø„É≥
                document.getElementById('debug-toggle-btn').addEventListener('click', () => {
                    const panel = document.getElementById('debug-panel');
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                });

                // God Mode
                document.getElementById('god-mode-btn').addEventListener('click', (e) => {
                    this.godMode = !this.godMode;
                    e.target.innerText = `God Mode: ${this.godMode ? 'ON' : 'OFF'}`;
                    e.target.classList.toggle('active');
                });

                // Mission Skip
                document.getElementById('skip-mission-btn').addEventListener('click', () => {
                    this.game.skipMission();
                });

                // „Éó„É¨„Ç§„É§„ÉºÈÄüÂ∫¶„Çπ„É©„Ç§„ÉÄ„Éº
                const playerSpeedSlider = document.getElementById('player-speed');
                playerSpeedSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    this.game.player.speed = value;
                    document.getElementById('player-speed-val').innerText = value.toFixed(2);
                });

                // ÊïµÈÄüÂ∫¶„Çπ„É©„Ç§„ÉÄ„Éº
                const enemySpeedSlider = document.getElementById('enemy-speed');
                enemySpeedSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    this.game.enemy.speed = value;
                    document.getElementById('enemy-speed-val').innerText = value.toFixed(2);
                });

                // Visual Debug
                document.getElementById('visual-debug-btn').addEventListener('click', (e) => {
                    this.visualDebug = !this.visualDebug;
                    e.target.innerText = `Ë¶ñË¶ö„Éá„Éê„ÉÉ„Ç∞: ${this.visualDebug ? 'ON' : 'OFF'}`;
                    e.target.classList.toggle('active');
                });
            }

            update() {
                // Êïµ„ÅÆÁä∂ÊÖã„ÇíË°®Á§∫
                document.getElementById('debug-state-text').innerText = `Áä∂ÊÖã: ${this.game.enemy.getState()}`;

                // Ë¶ñË¶ö„Éá„Éê„ÉÉ„Ç∞: „É¨„Ç§„Ç≠„É£„Çπ„Éà„É©„Ç§„É≥
                if (this.visualDebug) {
                    this.clearDebugLines();
                    this.drawRaycastLine();
                } else {
                    this.clearDebugLines();
                }
            }

            drawRaycastLine() {
                const enemyPos = this.game.enemy.getPosition();
                const playerPos = this.game.player.getPosition();

                const material = new THREE.LineBasicMaterial({ color: 0xff0000 });
                const points = [
                    new THREE.Vector3(enemyPos.x, enemyPos.y + 1, enemyPos.z),
                    new THREE.Vector3(playerPos.x, playerPos.y + 0.5, playerPos.z)
                ];
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.Line(geometry, material);
                
                this.game.scene.add(line);
                this.debugLines.push(line);
            }

            clearDebugLines() {
                this.debugLines.forEach(line => this.game.scene.remove(line));
                this.debugLines = [];
            }

            isGodMode() {
                return this.godMode;
            }
        }

        // ==========================================
        // Game: „É°„Ç§„É≥„Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ
        // ==========================================
        class Game {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.player = null;
                this.enemy = null;
                this.inputManager = null;
                this.debugPanel = null;

                this.walls = [];
                this.missions = [];
                this.missionIndex = 0;
                this.missionTypes = [
                    { name: "„Åä„ÇÇ„Å°„ÇÉ „Çí „Åã„Åü„Å•„Åë„Å¶ÔºÅ", type: "toy", color: 0xFF0000 },
                    { name: "„Éè„Éü„Ç¨„Ç≠ „Åó„Çà„ÅÜÔºÅ", type: "brush", color: 0x0000FF },
                    { name: "„Éê„Éä„Éä „Åü„Åπ„ÇãÔºÅ", type: "banana", color: 0xFFFF00 },
                    { name: "„Ç¥„Éº„É´ÔºÅ„Åä„Åµ„Çç„Å∏ÔºÅ", type: "bath", color: 0x00FFFF }
                ];

                this.isThirdPerson = true;
                this.isGameOver = false;
                this.isGameClear = false;
                this.isPaused = true;

                this.doorObject = null;

                this.init();
            }

            init() {
                // „Ç∑„Éº„É≥
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(CONFIG.world.skyColor);
                this.scene.fog = new THREE.Fog(CONFIG.world.skyColor, 10, 40);

                // „Ç´„É°„É©
                this.camera = new THREE.PerspectiveCamera(
                    CONFIG.camera.fov,
                    window.innerWidth / window.innerHeight,
                    CONFIG.camera.near,
                    CONFIG.camera.far
                );

                // „É¨„É≥„ÉÄ„É©„Éº
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.getElementById('game-container').appendChild(this.renderer.domElement);

                // „É©„Ç§„Éà
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);

                const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
                dirLight.position.set(10, 20, 10);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = CONFIG.shadows.resolution;
                dirLight.shadow.mapSize.height = CONFIG.shadows.resolution;
                dirLight.shadow.bias = CONFIG.shadows.bias;
                dirLight.shadow.camera.left = -20;
                dirLight.shadow.camera.right = 20;
                dirLight.shadow.camera.top = 20;
                dirLight.shadow.camera.bottom = -20;
                this.scene.add(dirLight);

                // Â∫äÔºà„ÉÜ„ÇØ„Çπ„ÉÅ„É£ÈÅ©Áî®Ôºâ
                const floorGeo = new THREE.PlaneGeometry(100, 100);
                const grassTex = TextureGenerator.createGrassTexture();
                const floorMat = new THREE.MeshStandardMaterial({ map: grassTex });
                const floor = new THREE.Mesh(floorGeo, floorMat);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                this.scene.add(floor);

                // Â£ÅÁîüÊàê
                this.createWalls();

                // „Éó„É¨„Ç§„É§„Éº„Å®Êïµ
                this.player = new Player(this.scene);
                this.enemy = new Enemy(this.scene);

                // „Éü„ÉÉ„Ç∑„Éß„É≥ÈÖçÁΩÆ
                this.placeMissions();

                // „Éâ„Ç¢
                this.createLockedDoor();

                // ÂÖ•ÂäõÁÆ°ÁêÜ
                this.inputManager = new InputManager();
                this.inputManager.setupTouchControls();
                this.setupButtons();

                // „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´
                this.debugPanel = new DebugPanel(this);

                // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥
                document.getElementById('start-btn').addEventListener('click', () => {
                    this.startGame();
                });

                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
                this.animate();

                // ÂàùÊúü„Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫
                document.getElementById('overlay').style.display = 'flex';
            }

            createWalls() {
                const woodTex = TextureGenerator.createWoodTexture();
                const wallMat = new THREE.MeshStandardMaterial({ map: woodTex });
                const wallGeo = new THREE.BoxGeometry(
                    CONFIG.world.wallSize,
                    CONFIG.world.wallHeight,
                    CONFIG.world.wallSize
                );

                // „Éó„É≠„Ç∑„Éº„Ç∏„É£„É´È¢®„ÅÆÂ£ÅÈÖçÁΩÆÔºàËø∑Ë∑Ø„Éû„ÉÉ„ÉóÔºâ
                const map = [
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 0, 1, 0, 0, 1],
                    [1, 0, 1, 1, 1, 0, 1, 0, 0, 1],
                    [1, 0, 0, 0, 1, 0, 0, 0, 0, 1],
                    [1, 1, 1, 0, 1, 1, 1, 1, 0, 1],
                    [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 1, 1, 0, 1, 1, 1, 0, 1],
                    [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
                ];

                for (let z = 0; z < map.length; z++) {
                    for (let x = 0; x < map[z].length; x++) {
                        if (map[z][x] === 1) {
                            const wall = new THREE.Mesh(wallGeo, wallMat);
                            wall.position.set(
                                (x - 5) * CONFIG.world.wallSize,
                                CONFIG.world.wallHeight / 2,
                                (z - 4) * CONFIG.world.wallSize
                            );
                            wall.castShadow = true;
                            wall.receiveShadow = true;
                            this.scene.add(wall);
                            this.walls.push(wall);
                        }
                    }
                }
            }

            placeMissions() {
                const positions = [
                    { x: -6, z: -6 },
                    { x: 6, z: -6 },
                    { x: -6, z: 6 },
                    { x: 0, z: 8 }
                ];

                for (let i = 0; i < 4; i++) {
                    const geo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
                    const mat = new THREE.MeshStandardMaterial({ color: this.missionTypes[i].color });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set(positions[i].x, 0.5, positions[i].z);
                    mesh.castShadow = true;
                    mesh.userData = { id: i, active: true };
                    this.scene.add(mesh);
                    this.missions.push(mesh);

                    if (i > 0) mesh.visible = false;
                }
            }

            createLockedDoor() {
                const geo = new THREE.BoxGeometry(2, 3, 0.2);
                const mat = new THREE.MeshStandardMaterial({ color: 0xFF69B4 });
                this.doorObject = new THREE.Mesh(geo, mat);
                this.doorObject.position.set(0, 1.5, 7);
                this.doorObject.castShadow = true;
                this.scene.add(this.doorObject);
                this.walls.push(this.doorObject);
            }

            setupButtons() {
                document.getElementById('btn-camera').addEventListener('click', () => {
                    this.isThirdPerson = !this.isThirdPerson;
                });

                document.getElementById('btn-action').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.checkAction();
                });
            }

            startGame() {
                document.getElementById('overlay').style.display = 'none';
                this.isPaused = false;
                this.isGameOver = false;
                this.isGameClear = false;
                this.missionIndex = 0;
                this.updateMissionDisplay();
                this.speak("„Åï„ÅÇ„ÄÅ„ÅÇ„Åù„Åº„ÅÜÔºÅ„Åä„ÇÇ„Å°„ÇÉ„Çí„Åã„Åü„Å•„Åë„Å¶„Å≠");
                this.resetGame();
            }

            resetGame() {
                this.player.reset();
                this.enemy.reset();
                this.missions.forEach(m => m.visible = false);
                this.missions[0].visible = true;
                this.missionIndex = 0;
                this.doorObject.visible = true;
                this.doorObject.position.set(0, 1.5, 7);
            }

            updateMissionDisplay() {
                if (this.missionIndex < this.missionTypes.length) {
                    document.getElementById('message-box').innerHTML =
                        "„Éü„ÉÉ„Ç∑„Éß„É≥Ôºö<br>" + this.missionTypes[this.missionIndex].name;
                    this.missions.forEach(m => m.visible = false);
                    this.missions[this.missionIndex].visible = true;
                }
            }

            checkAction() {
                if (this.missionIndex < this.missions.length) {
                    const target = this.missions[this.missionIndex];
                    const dist = this.player.getPosition().distanceTo(target.position);

                    if (dist < 2.0 && target.visible) {
                        this.missionIndex++;
                        this.speak("„Åß„Åç„ÅüÔºÅ„Åô„Åî„ÅÑ„Åô„Åî„ÅÑÔºÅ");

                        if (this.missionIndex >= this.missionTypes.length) {
                            this.gameClear();
                        } else {
                            this.updateMissionDisplay();
                            if (this.missionIndex === 3) {
                                this.startQuiz();
                            }
                        }
                    }
                }
            }

            skipMission() {
                if (this.missionIndex < this.missionTypes.length - 1) {
                    this.missionIndex++;
                    this.updateMissionDisplay();
                    this.speak("„Éü„ÉÉ„Ç∑„Éß„É≥„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü");
                } else {
                    this.gameClear();
                }
            }

            startQuiz() {
                this.isPaused = true;
                const overlay = document.getElementById('overlay');
                const text = document.getElementById('overlay-text');
                const options = document.getElementById('quiz-options');
                const startBtn = document.getElementById('start-btn');

                startBtn.style.display = 'none';
                overlay.style.display = 'flex';
                options.style.display = 'block';
                text.innerHTML = "„Éî„É≥„ÇØ„ÅÆ„Éâ„Ç¢„Åå„ÅÇ„Çã„ÇàÔºÅ<br>„Äå„ÅÇ„Åã„ÅÑ„Çç„Äç„ÅÆ „Éú„Çø„É≥„ÅØ„Å©„ÇåÔºü";
                this.speak("„Éî„É≥„ÇØ„ÅÆ„Éâ„Ç¢„Åå„ÅÇ„Çã„Çà„ÄÇ„ÅÇ„Åã„ÅÑ„Çç„ÅÆ„Éú„Çø„É≥„ÅØ„Å©„Çå„Åã„Å™Ôºü");

                options.innerHTML = '';
                const colors = [
                    { name: '„ÅÇ„Åã', code: '#FF0000', correct: true },
                    { name: '„ÅÇ„Åä', code: '#0000FF', correct: false },
                    { name: '„Åç„ÅÑ„Çç', code: '#FFFF00', correct: false }
                ];

                colors.sort(() => Math.random() - 0.5);

                colors.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'quiz-btn';
                    btn.style.backgroundColor = c.code;
                    btn.innerText = c.name;
                    btn.onclick = () => {
                        if (c.correct) {
                            this.speak("„Åõ„ÅÑ„Åã„ÅÑÔºÅ„Éâ„Ç¢„Åå„ÅÇ„ÅÑ„Åü„ÇàÔºÅ");
                            this.doorObject.visible = false;
                            this.doorObject.position.y = -10;
                            this.isPaused = false;
                            overlay.style.display = 'none';
                        } else {
                            this.speak("„Å°„Åå„ÅÜ„Çà„ÄÅ„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑÔºÅ");
                        }
                    };
                    options.appendChild(btn);
                });
            }

            gameOver() {
                this.isGameOver = true;
                this.isPaused = true;
                const overlay = document.getElementById('overlay');
                const text = document.getElementById('overlay-text');
                const startBtn = document.getElementById('start-btn');
                const options = document.getElementById('quiz-options');

                options.style.display = 'none';
                startBtn.style.display = 'block';
                startBtn.innerText = "„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑÔºÅ";
                text.innerHTML = "„Å§„Åã„Åæ„Å£„Å°„ÇÉ„Å£„ÅüÔºÅ<br>„Ç§„É§„Ç§„É§„Åó„Å™„ÅÑÔºü";
                overlay.style.display = 'flex';

                this.speak("„Ç§„É§„Ç§„É§„Åó„Å¶„Çã„Å®„ÄÅ„Å§„Åã„Åæ„Åà„Å°„ÇÉ„ÅÜ„Åû„ÉºÔºü");
            }

            gameClear() {
                this.isGameClear = true;
                this.isPaused = true;
                const overlay = document.getElementById('overlay');
                const text = document.getElementById('overlay-text');
                const startBtn = document.getElementById('start-btn');
                const options = document.getElementById('quiz-options');

                options.style.display = 'none';
                startBtn.style.display = 'block';
                startBtn.innerText = "„Åæ„Åü„ÅÇ„Åù„Å∂";
                text.innerHTML = "„ÇØ„É™„Ç¢ÔºÅ<br>„Çä„Åè„Åè„Çì „Åã„Å£„Åì„ÅÑ„ÅÑÔºÅ";
                overlay.style.display = 'flex';

                this.speak("„Åô„Åî„Éº„ÅÑÔºÅÂÖ®ÈÉ®„Åß„Åç„Åü„Å≠ÔºÅ„Çä„Åè„Åè„Çì„Åã„Å£„Åì„ÅÑ„ÅÑÔºÅ");
            }

            speak(text) {
                if (!window.speechSynthesis) return;
                const ut = new SpeechSynthesisUtterance(text);
                ut.lang = 'ja-JP';
                ut.rate = 1.0;
                ut.pitch = 1.2;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(ut);
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                if (!this.isPaused && !this.isGameOver && !this.isGameClear) {
                    // „Éó„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
                    const input = this.inputManager.getMovementInput();
                    this.player.update(input, this.walls);

                    // ÊïµÊõ¥Êñ∞
                    const currentMissionPos = this.missionIndex < this.missions.length ?
                        this.missions[this.missionIndex].position : null;
                    this.enemy.update(this.player.getPosition(), currentMissionPos, this.walls, this.scene);

                    // ÂΩì„Åü„ÇäÂà§ÂÆöÔºàGod Mode „ÉÅ„Çß„ÉÉ„ÇØÔºâ
                    const distToEnemy = this.player.getPosition().distanceTo(this.enemy.getPosition());
                    if (distToEnemy < CONFIG.enemy.catchDistance && !this.debugPanel.isGodMode()) {
                        this.gameOver();
                    }

                    // „Éü„ÉÉ„Ç∑„Éß„É≥„Ç¢„Ç§„ÉÜ„É†„ÅÆÂõûËª¢
                    this.missions.forEach(m => {
                        if (m.visible) {
                            m.rotation.y += 0.05;
                            m.rotation.x += 0.02;
                        }
                    });
                }

                // „Ç´„É°„É©Êõ¥Êñ∞
                if (this.isThirdPerson) {
                    const offset = new THREE.Vector3(
                        CONFIG.camera.thirdPersonOffset.x,
                        CONFIG.camera.thirdPersonOffset.y,
                        CONFIG.camera.thirdPersonOffset.z
                    );
                    this.camera.position.copy(this.player.getPosition()).add(offset);
                    this.camera.lookAt(this.player.getPosition());
                } else {
                    this.camera.position.copy(this.player.getPosition());
                    this.camera.position.y += CONFIG.camera.firstPersonOffset.y;
                    
                    const input = this.inputManager.getMovementInput();
                    if (input.active) {
                        const lookTarget = new THREE.Vector3(
                            this.player.getPosition().x + input.x * 10,
                            this.player.getPosition().y,
                            this.player.getPosition().z + input.y * 10
                        );
                        this.camera.lookAt(lookTarget);
                    }
                }

                // „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´Êõ¥Êñ∞
                this.debugPanel.update();

                this.renderer.render(this.scene, this.camera);
            }
        }

        // ==========================================
        // Ëµ∑Âãï
        // ==========================================
        window.onload = () => {
            new Game();
        };

    </script>
</body>

</html>